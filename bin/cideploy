#!/bin/sh

# exit on error
set -e

# print each command
set -x

# configure git
git config --global credential.helper store
git config user.name "Auto-deploy via Travis CI"
git config user.email "kdmgithub@users.noreply.github.com"

# cleanup after the CI build so we can switch branch
git checkout _data/facebook

# where are we at
REV=`git rev-parse --short HEAD`

# change to gh-pages branch
git fetch origin master:master
git checkout master

# checkout .gitignore from dev branch
git checkout dev -- .gitignore

# master branch should always ignore data files
echo "/_data/" >> .gitignore

# sync .gitignore
git commit --allow-empty -m "sync .gitignore with dev branch"

# commit site changes
cp -r -f _site/* .
git add .
git commit -m "deploy ${REV} (${TRAVIS_EVENT_TYPE})"

# stop printing commands, because GITHUB_ACCESS_TOKEN would be leaked
set +x

# make the github credentials available to git operations
echo https://${GITHUB_ACCESS_TOKEN}:x-oauth-basic@github.com >> ~/.git-credentials

# print each command again
set -x

# update the public site
git push https://github.com/klubbdinmamma/klubbdinmamma.github.io.git master
